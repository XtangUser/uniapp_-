"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/system.js"),l=require("../../api/apis.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-rate")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const o={__name:"preview",props:{id:String,type:String},setup(o){const t=e.ref([]),i=e.ref(null),s=e.ref(!0),u=e.ref(0),n=e.ref(null),r=()=>{s.value=!s.value},c=e.ref(null),p=e=>{e?c.value.open():c.value.close()},v=e=>{e?(n.value.open(),i.value.userScore?(g.value=!0,u.value=i.value.userScore):u.value=i.value.score):(n.value.close(),u.value=0,g.value=!1)},d=e.ref(null);let m=o;const f=e.ref(null),h=e.ref([]);!async function(){if(d.value=m.id,t.value=e.index.getStorageSync("storageClassList")||[],"share"==m.type){let e=await l.apiDetailWall({id:m.id});t.value=e.data.map((e=>({...e,picUrl:e.smallPicurl.replace("_small.webp",".jpg")})))}else t.value=t.value.map((e=>({...e,picUrl:e.smallPicurl.replace("_small.webp",".jpg")})));f.value=t.value.findIndex((e=>e._id==m.id)),i.value=t.value[f.value],y()}();const g=e.ref(!1),w=async()=>{try{e.index.showLoading({title:"加载中..."}),0===(await l.apiGetSetupScore({classid:i.value.classid,wallId:i.value._id,userScore:u.value})).errCode?(e.index.showToast({title:"评分成功!",icon:"success"}),t.value[f.value].userScore=u.value,e.index.setStorageSync("storageClassList",t.value)):e.index.showToast({title:"失败!",icon:"error"}),v()}finally{e.index.hideLoading()}},x=()=>{e.index.navigateBack({success(){},fail(){e.index.reLaunch({url:"/pages/index/index"})}})};function y(){const e=t.value.length-1;h.value=[0===f.value?e:f.value-1,f.value,f.value===e?0:f.value+1],h.value=[...new Set(h.value)]}const S=e=>{i.value=t.value[e.detail.current],f.value=e.detail.current,y()};return e.onShareAppMessage((()=>({title:"小唐壁纸酷",path:`/pages/preview/preview?id=${d.value}&type="share"`}))),e.onShareTimeline((()=>({title:"小唐壁纸酷",query:"id="+d.value+"&type=share"}))),(o,d)=>e.e({a:i.value},i.value?e.e({b:e.f(t.value,((a,l,o)=>e.e({a:h.value.includes(l)},h.value.includes(l)?{b:a.picUrl,c:e.o(r,a._id)}:{},{d:a._id}))),c:f.value,d:e.o(S),e:s.value},s.value?{f:e.p({type:"back",color:"#fff",size:"20"}),g:e.o(x),h:e.unref(a.getStatusBarHeight)()+"px",i:e.t(f.value+1),j:e.t(t.value.length),k:e.p({date:Date.now(),format:"hh:mm"}),l:e.p({date:Date.now(),format:"MM月/dd日"}),m:e.p({type:"info",size:"23"}),n:e.o((e=>p(!0))),o:e.p({type:"star",size:"23"}),p:e.t(i.value.score),q:e.o((e=>v(!0))),r:e.p({type:"download",size:"23"}),s:e.o((a=>(async()=>{try{e.index.showLoading({title:"下载中...",mask:!0});let{classid:a,_id:o}=i.value,t=await l.apiWriteDownload({classid:a,wallId:o});if(0!=t.errCode)throw t;e.index.getImageInfo({src:i.value.picUrl,success:a=>{e.index.saveImageToPhotosAlbum({filePath:a.path,success:a=>{e.index.showToast({title:"保存成功，请到相册查看",icon:"none"})},fail:a=>{"saveImageToPhotosAlbum:fail cancel"!=a.errMsg?e.index.showModal({title:"授权提示",content:"需要授权保存相册",success:a=>{a.confirm&&e.index.openSetting({success:a=>{a.authSetting["scope.writePhotosAlbum"]?e.index.showToast({title:"获取授权成功",icon:"none"}):e.index.showToast({title:"获取权限失败",icon:"none"})}})}}):e.index.showToast({title:"保存失败，请重新点击下载",icon:"none"})},complete:()=>{e.index.hideLoading()}})}})}catch(a){e.index.hideLoading()}})()))}:{}):{},{t:e.p({type:"closeempty",size:"18",color:"#999"}),v:e.o((e=>p(!1))),w:e.t(i.value.classid),x:e.t(i.value.tabs[1]),y:e.t(i.value.nickname),z:e.p({readonly:"true",value:"5",touchable:"false",size:"16"}),A:e.t(i.value.score),B:e.t(i.value.description),C:e.f(i.value.tabs,((a,l,o)=>({a:e.t(a),b:l}))),D:e.sr(c,"9e23b0fe-6",{k:"infoPopup"}),E:e.p({type:"bottom"}),F:e.t(g.value||i.value.userScore?"已经评分过了~":"壁纸评分"),G:e.p({type:"closeempty",size:"18",color:"#999"}),H:e.o((e=>v(!1))),I:e.o((e=>u.value=e)),J:e.p({size:18,"allow-half":!0,disabled:g.value,modelValue:u.value}),K:e.t(u.value),L:e.o(w),M:g.value||i.value.userScore,N:e.sr(n,"9e23b0fe-9",{k:"scorePopup"}),O:e.p({"is-mask-click":!1})})}},t=e._export_sfc(o,[["__scopeId","data-v-9e23b0fe"]]);o.__runtimeHooks=6,wx.createPage(t);
